#!/bin/sh
############################################################
#
# Program history
############################################################
# Created by. Daejeon Office
# 2022.03.18 Version : Park Si Hyung, Yoon Jun Su
#

############################################################
#
# Program variables
############################################################
# Configuration file path
TBIS_AUTO_LOGFILE="tbis.log"
TBIS_AUTO_CFGFILE="tbis.cfg"
TBIS_AUTO_SQLFILE="tbis.sql"
TBIS_CWD_PATH=`pwd`
############################################################
#
# Function lists
############################################################
FN_AUTO_LOGFILE(){
    TBIS_AUTO_TIME=`date +%F_%T |sed 's/://g' |sed 's/-//g'`

    if [ -f $TBIS_AUTO_LOGFILE ]
    then
        mv $TBIS_AUTO_LOGFILE "$TBIS_AUTO_LOGFILE"_"$TBIS_AUTO_TIME"
    fi

    echo "############### tbis LOG" > $TBIS_AUTO_LOGFILE
    echo $TBIS_AUTO_TIME >> $TBIS_AUTO_LOGFILE
    echo >> $TBIS_AUTO_LOGFILE
    echo >> $TBIS_AUTO_LOGFILE
}

FN_AUTO_PROGRESS_CHECK(){
    echo
    printf "continue ? ( [Y]es / [N]o / [S]kip ) : "
    read INPUT_YESNO
    case $INPUT_YESNO in
        "YES"|"Yes"|"yes"|"y"|"Y")
            YESNO=YES;;
        "NO"|"No"|"no"|"n"|"N")
            exit;;
        "SKIP"|"Skip"|"S"|"s")
            YESNO=SKIP;;
    esac
    echo
}

FN_AUTO_ENGINE(){    
    # Engine install
    if [ $TIBERO_ENGINE == "Y" ] || [ $TIBERO_ENGINE == "y" ]
    then
        echo
        echo "############################################################"
        echo "# tbis Progress> Engine"
        echo "############################################################"
        echo
        echo "tar -xvzf ../binary/tibero*.tar.gz -C $USER_HOME"
        echo
        FN_AUTO_PROGRESS_CHECK
        if [ $YESNO == "YES" ]
        then
            tar -xvzf ../binary/tibero*.tar.gz -C $USER_HOME
        fi     
    fi
    
}


FN_AUTO_TBINARY(){
    if [ $TIBERO_TBINARY == "Y" ] || [ $TIBERO_TBINARY == "y" ]
    then
        echo
        echo "############################################################"
        echo "# tbis Progress> tbinary"
        echo "############################################################"
        echo
        echo "tar -xvf ../binary/tbinary*.tar -C $USER_HOME"
        echo
        FN_AUTO_PROGRESS_CHECK
        if [ $YESNO == "YES" ]
        then
            tar -xvf ../binary/tbinary*.tar -C $USER_HOME
        fi  
    fi
}

FN_AUTO_PROFILE()
{
    echo
    echo "############################################################"
    echo "# tbis Progress> Profile " 
    echo "############################################################"
    echo
    FN_AUTO_PROGRESS_CHECK
    if [ $YESNO == "YES" ]
    then
        TIBERO_BASHPROFILE=`ls $USER_HOME/.bash_profile`
        TIBERO_PROFILE=`ls $USER_HOME/.profile`
        if [ -z $TIBERO_PROFILE ]
        then   
            sh tbis.cfg USER_PROFILE >> $USER_HOME/.bash_profile
        elif [ -z $TIBERO_BASHPROFILE ]
        then
            sh tbis.cfg USER_PROFILE >> $USER_HOME/.profile
        fi
    fi
}

FN_AUTO_LICENSE(){
    if [ -z $TIBERO_LICENSE ]
    then
        echo
        echo "# tbis message>../binary/license.xml file"
        echo
        exit
    else
        echo
        echo "############################################################"
        echo "# tbis Progress> license apply "    
        echo "############################################################"
        echo
        echo "cp ../binary/license.xml $TB_HOME/license/license.xml"
        echo
        FN_AUTO_PROGRESS_CHECK
        if [ $YESNO == "YES" ]
        then
            cp ../binary/license.xml $TB_HOME/license/license.xml   
        fi
        
    fi
}

FN_AUTO_TB_SID_TIP(){
    echo
    echo "############################################################"
    echo "# tbis Progress> TB_SID TIP File"
    echo "############################################################"
    echo
    echo "sh tbis.cfg TB_SID_TIP > $TB_HOME/config/$TB_SID.tip"
    echo
    FN_AUTO_PROGRESS_CHECK        
    if [ $YESNO == "YES" ]
    then
        sh tbis.cfg TB_SID_TIP > $TB_HOME/config/$TB_SID.tip        
    fi
}

FN_AUTO_CM_SID_TIP(){
    echo
    echo "############################################################"
    echo "# tbis Progress> CM_SID TIP File"
    echo "############################################################"
    echo
    echo "sh tbis.cfg CM_SID_TIP > $TB_HOME/config/$TIBERO_NODE.tip"
    echo
    FN_AUTO_PROGRESS_CHECK
    if [ $YESNO == "YES" ]
    then
        if [ $TIBERO_TYPE == "SINGLE" ]
        then
            echo "SINGLE"
        else
            sh tbis.cfg CM_SID_TIP > $TB_HOME/config/$TIBERO_NODE.tip
        fi
    fi
}

FN_AUTO_TBDSN(){
    echo
    echo "############################################################"
    echo "# tbis Progress> TBDSN"
    echo "############################################################"
    echo
    echo "sh tbis.cfg FN_TB_DSN > $TB_HOME/client/cofnig/tbdsn.tbr"
    echo
    FN_AUTO_PROGRESS_CHECK
    if [ $YESNO == "YES" ]
    then
        sh tbis.cfg TB_DSN > $TB_HOME/client/config/tbdsn.tbr
    fi
}

FN_AUTO_SINGLE(){
    export TB_SID=`echo $DB_NAME`
}

FN_AUTO_TSC(){
    export TB_SID=`echo "$DB_NAME"_p`
    export TB_SID=`echo "$DB_NAME"_s`
}

FN_AUTO_TAC(){
    export TB_SID=`echo "$DB_NAME"0`
    export TB_SID=`echo "$DB_NAME"1`
}


FN_AUTO_CHANGE_OWNER(){
    # Owner Change Files
    echo "############################################################"
    echo "#  tbis Progress> Change Owner"
    echo "############################################################"
    echo
    echo "chwon -R $USER_NAME:$GROUP_NAME $USER_HOME"
    echo
    FN_AUTO_PROGRESS_CHECK
    if [ $YESNO == "YES" ]
    then
        chown -R $USER_NAME:$GROUP_NAME $USER_HOME
    fi
    
}

FN_AUTO_TB_BOOT(){
    echo "############################################################"
    echo "#  tbis Progress> tbboot"
    echo "############################################################"
    echo
    echo "su - $USER_NAME -c \"tbboot\""
    echo
    FN_AUTO_PROGRESS_CHECK
    if [ $YESNO == "YES" ]
    then
        TIBERO_PROCESS=`ps -ef |grep tbsvr |grep -v grep`
        if [ -z $TIBERO_PROCESS ]
        then
            su - $USER_NAME -c "tbboot"
        else
            ps -ef |grep tbsvr |grep -v grep
        fi
    fi
}

FN_AUTO_CREATEDB(){
    echo "############################################################"
    echo "#  tbis Progress> CREATE DATABASE"
    echo "############################################################"
    echo
    echo "@$TBIS_CWD_PATH/tbis.sql"
    echo
    FN_AUTO_PROGRESS_CHECK
    echo
    if [ $YESNO == "YES" ]
    then    
        su - tibero_tbis -c "
            tbsql -s sys/tibero <<EOF
            @$TBIS_CWD_PATH/tbis.sql
            exit
            EOF
        "
    fi
}

FN_AUTO_SYSTEM_SHELL(){
    echo "############################################################"
    echo "#  tbis Progress> system.sh"
    echo "############################################################"
    echo
    echo "su - tibero_tbis -c \"sh $TB_HOME/scripts/system.sh -p1 tibero -p2 syscat -a1 Y -a2 Y -a3 Y -a4 Y\""
    echo
    FN_AUTO_PROGRESS_CHECK
    echo
    if [ $YESNO == "YES" ]
    then    
        su - tibero_tbis -c "sh $TB_HOME/scripts/system.sh -p1 tibero -p2 syscat -a1 Y -a2 Y -a3 Y -a4 Y"
    fi    
}


FN_AUTO_INSTALL(){   
    . ./tbis.cfg

    TIBERO_LICENSE=`cat ../binary/license.xml |grep license |head -n 1 `
    echo "[*] TIBERO Auto installation Tools Configuration Checking STEP"
    echo "-----------------------------------------------------------------"
    echo "# System Check"
    echo "- OS USER : $USER_NAME"
    echo "- OS USER GROUP : $USER_GROUP"
    echo "- OS HOME : $USER_HOME"
    echo "-----------------------------------------------------------------"
    echo "# TIBERO Binary"
    if [ -n $TIBERO_ENGINE ]
    then
        echo "- engine : $TB_HOME"
    fi  

    if [ -n $TIBERO_TBINARY ]
    then
        echo "- tbinary : $TB_HOME/tbinary"
    fi
    echo "-----------------------------------------------------------------"
    echo "# TIBERO DATABASE"
    if [ $TIBERO_TYPE == "SINGLE" ]
    then
        echo "- TIBERO TYPE : SINGLE"
        FN_AUTO_SINGLE
    elif [ $TIBERO_TYPE == "TSC" ]
    then
        echo "- TIBERO TYPE : TSC"
        echo "- TIBERO NODE : $TIBERO_NODE"
        FN_AUTO_TSC
    elif [ $TIBERO_TYPE == "TAC" ]
    then
        echo "- TIBERO TYPE : TAC"
        echo "- TIBERO NODE : $TIBERO_NODE"
        FN_AUTO_TAC
    fi
    echo "- TB_SID : $TB_SID"
    echo "- CM_SID : $TIBERO_NODE"
    echo "- CHARACTER SET : `cat tbis.sql|grep CHARACTER |awk '{print $NF}'`"
    echo "-----------------------------------------------------------------"
    echo "# TIBERO Configuration Files"
    echo "- cat tbis.cfg : TIBERO Total Configuration File"
    echo "- cat tbis.sql : CREATE DATABASE SQL File"
    echo "-----------------------------------------------------------------"
    
    FN_AUTO_PROGRESS_CHECK
    
    if [ -z $USER_HOME  ]
    then
        echo " tbis message> User home checking "
        exit
    fi

    ############# In Progress
    FN_AUTO_ENGINE
    FN_AUTO_TBINARY
    FN_AUTO_LICENSE
    FN_AUTO_PROFILE
    FN_AUTO_TB_SID_TIP
    FN_AUTO_CM_SID_TIP
    FN_AUTO_TBDSN
    FN_AUTO_CHANGE_OWNER
    FN_AUTO_TB_BOOT
    FN_AUTO_CREATEDB
    FN_AUTO_TB_BOOT
    FN_AUTO_SYSTEM_SHELL
    ############
}

FN_AUTO_CFG(){
    echo " -----------------------------------------------------------------------------------"
    echo "  1.TIBERO USER CREATE                      |  2.TIBERO User Profile                  "
    echo " ---------------------------------------- + ----------------------------------------"
    echo "  # 11 - MANUAL                             |  # 21 - MANUAL                            "
    echo "                                            |                                         "
    echo " -----------------------------------------------------------------------------------"
    echo "  3.TIBERO Directory                        |  4.TIBERO TIP                           "
    echo " ---------------------------------------- + ----------------------------------------"
    echo "  # 31 - MANUAL                             |  # 41 - MANUAL                            "
    echo "                                            |                                         "
    echo " -----------------------------------------------------------------------------------"
    echo "  5.TIBERO CREATE DATABASE                  |  6.TIBERO CM Resource                   "
    echo " ---------------------------------------- + ----------------------------------------"
    echo "  # 51 - MANUAL                             |  # 61 - MANUAL                            "
    echo "                                            |                                         "
    echo " -----------------------------------------------------------------------------------"
    echo "  c  - Clear terminal                                                               "
    echo "  r  - retry main menu                                                              "
    echo "  press other key to quit                                                                  "
    echo " -----------------------------------------------------------------------------------"
    printf " Choose the Number or Command : "
    read INPUT_NUMBER
}


FN_MAIN_MENU(){
    clear
    echo "[*] TIBERO Installation Shell Script"
    echo "[*] This script is for TmaxTibero "Daejeon Office" only."
    echo "[*] Supported Version : Tibero 6 FS07 ↑"
    echo "-----------------------------------------------------------------"
    echo "# 1. Auto installation"
    echo "# 2. Auto installation "
    echo "# 3. Auto Configuration Text"
    echo "-----------------------------------------------------------------"
    echo "# chk. System Check"
    echo "# ini. Configurations Initialization"
    echo "# press other key to quit"
    echo "-----------------------------------------------------------------"
    printf "Choose the Number : "
    read INPUT_NUMBER
    case $INPUT_NUMBER in
    1)
        clear
        FN_AUTO_LOGFILE
        FN_AUTO_INSTALL |tee $TBIS_AUTO_LOGFILE
        exit;;
    2)
        echo "2";;
    3)
        while true
        do
            FN_AUTO_CFG
        done;;
    *)
        clear
        echo "tbis message> program quit."
        exit;;
    esac
}

############################################################
#
# Program start
############################################################
# run
FN_MAIN_MENU
#FN_MAIN_MENU