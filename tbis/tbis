#!/bin/sh
############################################################
#
# Program history
############################################################
# Created by. Daejeon Office
# 2022.03.18 Version : Park Si Hyung, Yoon Jun Su
#

############################################################
#
# Program variables
############################################################
# Configuration file path
TBIS_AUTO_LOGFILE="tbis.log"
TBIS_AUTO_CFGFILE="tbis.cfg"
TBIS_AUTO_SQLFILE="tbis.sql"
TBIS_CWD_PATH=`pwd`

############################################################
#
# Function lists
############################################################
FN_AUTO_LOGFILE(){
    TBIS_AUTO_TIME=`date +%F_%T |sed 's/://g' |sed 's/-//g'`
    if [ -f $TBIS_AUTO_LOGFILE ]
    then
        mv $TBIS_AUTO_LOGFILE "$TBIS_AUTO_LOGFILE"_"$TBIS_AUTO_TIME"
    fi
}

FN_AUTO_PROGRESS_CHECK(){
    echo
    if [ $INSTALL_MODE == "ALL" ]
    then
        YESNO=YES
    else
        printf "continue ? ( [Y]es / [N]o / [S]kip ) : "
        read INPUT_YESNO
        case $INPUT_YESNO in
            "YES"|"Yes"|"yes"|"y"|"Y")
                YESNO=YES;;
            "NO"|"No"|"no"|"n"|"N")
                exit;;
            "SKIP"|"Skip"|"S"|"s")
                YESNO=SKIP;;
            *)
                exit;;
        esac
        echo
    fi
    
}

FN_AUTO_ENGINE(){    
    # Engine install
    if [ $TIBERO_ENGINE == "Y" ] || [ $TIBERO_ENGINE == "y" ]
    then
        echo
        echo "############################################################"
        echo "# tbis Progress> Engine"
        echo "############################################################"
        echo
        echo "tar -xvzf ../binary/tibero*.tar.gz -C $USER_HOME"
        echo
        FN_AUTO_PROGRESS_CHECK
        if [ $YESNO == "YES" ]
        then
            FILE_CHECK=`ls ../binary/tibero*.tar.gz`
            if [ -f $FILE_CHECK ]
            then
                tar -xvzf ../binary/tibero*.tar.gz -C $USER_HOME
            else
                echo "tbis message> tibero engine install file check"
                exit
            fi
        fi     
    fi
    
}

FN_AUTO_TBINARY(){
    if [ $TIBERO_TBINARY == "Y" ] || [ $TIBERO_TBINARY == "y" ]
    then
        echo
        echo "############################################################"
        echo "# tbis Progress> tbinary"
        echo "############################################################"
        echo
        echo "tar -xvf ../binary/tbinary*.tar -C $USER_HOME"
        echo
        FN_AUTO_PROGRESS_CHECK
        if [ $YESNO == "YES" ]
        then
            FILE_CHECK=`ls ../binary/tbinary*.tar`
            if [ -f $FILE_CHECK ]
            then
                tar -xvf  -C $USER_HOME
            else
                echo "tbis message> tibero tbinary file check"
                exit
            fi
        fi  
    fi
}

FN_AUTO_PROFILE(){
    echo
    echo "############################################################"
    echo "# tbis Progress> Profile " 
    echo "############################################################"
    echo
    echo ".bash_profile or .profile configuration"
    echo
    FN_AUTO_PROGRESS_CHECK
    if [ $YESNO == "YES" ]
    then
        TIBERO_BASHPROFILE=$USER_HOME/.bash_profile
        TIBERO_PROFILE=$USER_HOME/.profile
        if [ -f $TIBERO_PROFILE ]
        then
            echo ""
            TIBERO_PROFILE_CHECK=$TIBERO_PROFILE
            sh tbis.cfg USER_PROFILE >> $USER_HOME/.profile
        elif [ -f $TIBERO_BASHPROFILE ]
        then
            TIBERO_PROFILE_CHECK=$TIBERO_BASHPROFILE
            sh tbis.cfg USER_PROFILE >> $USER_HOME/.bash_profile
        else
            echo "tbis message> .bash_profile or .profile file check"
            exit
        fi
    fi
}

FN_AUTO_LICENSE(){
    if [ -z $TIBERO_LICENSE ]
    then
        echo
        echo "# tbis message>../binary/license.xml file"
        echo
        exit
    else
        echo
        echo "############################################################"
        echo "# tbis Progress> license "    
        echo "############################################################"
        echo
        echo "cp ../binary/license.xml $TB_HOME/license/license.xml"
        echo
        FN_AUTO_PROGRESS_CHECK
        if [ $YESNO == "YES" ]
        then
            FILE_CHECK=`ls ../binary/license.xml $TB_HOME/license/license.xml`
            if [ -f $FILE_CHECK ]
            then
                cp ../binary/license.xml $TB_HOME/license/license.xml
            else
                echo "tbis message> tibero license file check"
                exit
            fi

        fi
        
    fi
}

FN_AUTO_TB_SID_TIP(){
    echo
    echo "############################################################"
    echo "# tbis Progress> TB_SID TIP File"
    echo "############################################################"
    echo
    echo "sh tbis.cfg TB_SID_TIP > $TB_HOME/config/$TB_SID.tip"
    echo
    FN_AUTO_PROGRESS_CHECK        
    if [ $YESNO == "YES" ]
    then
        if [ -z $TB_SID]
        then
          echo "tbis message> \$TB_SID check"
          exit
        fi

        if [ $TIBERO_NODE == "observer" ]
        then
            2>/dev/null
        else
            sh tbis.cfg TB_SID_TIP > $TB_HOME/config/$TB_SID.tip        
        fi
    fi
}

FN_AUTO_CM_SID_TIP(){
    echo
    echo "############################################################"
    echo "# tbis Progress> CM_SID TIP File"
    echo "############################################################"
    echo
    echo "sh tbis.cfg CM_SID_TIP > $TB_HOME/config/$TIBERO_NODE.tip"
    echo
    FN_AUTO_PROGRESS_CHECK
    if [ $YESNO == "YES" ]
    then
        if [ -z $CM_SID]
        then
          echo "tbis message> \$CM_SID check"
          exit
        fi

        if [ $TIBERO_TYPE == "SINGLE" ]
        then
            echo "SINGLE"
        else
            sh tbis.cfg CM_SID_TIP > $TB_HOME/config/$TIBERO_NODE.tip
        fi
    fi
}

FN_AUTO_TBDSN(){
    echo
    echo "############################################################"
    echo "# tbis Progress> TBDSN"
    echo "############################################################"
    echo
    echo "sh tbis.cfg FN_TB_DSN > $TB_HOME/client/cofnig/tbdsn.tbr"
    echo
    FN_AUTO_PROGRESS_CHECK
    if [ $YESNO == "YES" ]
    then
        
        if [ -z $TB_HOME]
        then
          echo "tbis message> \$TB_HOME check"
          exit
        fi

        sh tbis.cfg TB_DSN > $TB_HOME/client/config/tbdsn.tbr
    fi
}

FN_AUTO_SINGLE(){
    export TB_SID=`echo $DB_NAME`
}

FN_AUTO_TSC(){
    if [ $TIBERO_NODE == "primary" ] 
    then
        export TB_SID=`echo "$DB_NAME"_p`
    elif [ $TIBERO_NODE == "standby" ]
    then
        export TB_SID=`echo "$DB_NAME"_s`
    elif [ $TIBERO_NODE == "observer" ]
    then
        export TB_SID="Observer Not TB_SID"
    fi
}

FN_AUTO_TAC(){
    if [ $TIBERO_NODE == "cm0" ]
    then
        export TB_SID=`echo "$DB_NAME"0`
    elif [ $TIBERO_NODE == "cm1" ]
    then
        export TB_SID=`echo "$DB_NAME"1`
    fi
}

FN_AUTO_PROGRESS_PROFILE(){
    TIBERO_BASHPROFILE=$USER_HOME/.bash_profile
    TIBERO_PROFILE=$USER_HOME/.profile

    if [ -f $TIBERO_PROFILE ]
    then
        TIBERO_PROFILE_CHECK=$TIBERO_PROFILE
    elif [ -f $TIBERO_BASHPROFILE ]
    then
        TIBERO_PROFILE_CHECK=$TIBERO_BASHPROFILE
    fi
}

FN_AUTO_CM_RESOURCE(){
    echo
    echo "############################################################"
    echo "# tbis Progress> tbcm resource "    
    echo "############################################################"
    echo
    sh tbis.cfg CM_RESOURCE
    echo
    FN_AUTO_PROGRESS_CHECK
    FN_AUTO_PROGRESS_PROFILE
    . $TIBERO_PROFILE_CHECK
    if [ $YESNO == "YES" ]
    then
        if [ $TIBERO_TYPE == "TSC" ]
        then
            if [ $TIBERO_NODE == "primary" ]
            then
                cmrctl add network --name net0 --ipaddr $NODE1_INTER_IP --portno 29000
                if [ -z $NODE1_VIP_ETH ]
                then
                    cmrctl add cluster --name cls0 --incnet net0 --cfile $TB_HOME/config/CMFILE_cls0
                    cmrctl start cluster --name cls0
                    cmrctl add service --name $DB_NAME --cname cls0 --tscid 11 --obsip $NODE2_INTER_IP --obsport 9050
                    cmrctl add db --name $TB_SID --svcname $DB_NAME --dbhome $TB_HOME --envfile $TIBERO_PROFILE_CHECK
                else
                    cmrctl add network --name pub0 --nettype public --ifname $NODE1_VIP_ETH
                    cmrctl add cluster --name cls0 --incnet net0 --pubnet pub0 --cfile $TB_HOME/config/CMFILE_cls0
                    cmrctl start cluster --name cls0
                    cmrctl add service --name $DB_NAME --cname cls0 --tscid 11 --obsip $NODE2_INTER_IP --obsport 9050
                    cmrctl add db --name $TB_SID --svcname $DB_NAME --dbhome $TB_HOME --envfile $TIBERO_PROFILE_CHECK   
                    cmrctl add vip --name vip0 --svcname $DB_NAME --ipaddr $NODE1_VIP_IP
                fi
            elif [ $TIBERO_NODE == "standby" ]
            then
                cmrctl add network --name net1 --ipaddr $NODE2_INTER_IP --portno 29000
                    if [ -z $NODE2_VIP_ETH ]
                    then
                        cmrctl add cluster --name cls1 --incnet net1 --cfile $TB_HOME/config/CMFILE_cls1
                        cmrctl start cluster --name cls1
                        cmrctl add service --name $DB_NAME --cname cls1 --tscid 11 --obsip $NODE2_INTER_IP --obsport 9050
                        cmrctl add db --name $TB_SID --svcname $DB_NAME --dbhome $TB_HOME --envfile $TIBERO_PROFILE_CHECK
                    else
                        cmrctl add network --name pub1 --nettype public --ifname $NODE2_VIP_ETH
                        cmrctl add cluster --name cls1 --incnet net1 --pubnet pub1 --cfile $TB_HOME/config/CMFILE_cls1
                        cmrctl start cluster --name cls1
                        cmrctl add service --name $DB_NAME --cname cls1 --tscid 11 --obsip $NODE2_INTER_IP --obsport 9050
                        cmrctl add db --name $TB_SID --svcname $DB_NAME --dbhome $TB_HOME --envfile $TIBERO_PROFILE_CHECK   
                        cmrctl add vip --name vip1 --svcname $DB_NAME --ipaddr $NODE2_VIP_IP
                    fi
            elif [ $TIBERO_NODE == "observer" ]
            then
                2>/dev/null
            fi
        elif [ $TIBERO_TYPE == "TAC" ]
        then
            2>/dev/null
            if [ $TIBERO_NODE == "cm0" ]
            then
                cmrctl add network --name net0 --ipaddr $NODE1_INTER_IP --portno 29000
                if [ -z $NODE1_VIP_ETH ]
                then
                    cmrctl add cluster --name cls0 --incnet net0 --cfile $CFILE_PATH/CMFILE
                    cmrctl start cluster --name cls0
                    cmrctl add service --name $DB_NAME --cname cls0 --type db
                    cmrctl add db --name $TB_SID --svcname $DB_NAME --dbhome $TB_HOME
                else
                    cmrctl add network --name pub0 --nettype public --ifname $NODE1_VIP_ETH
                    cmrctl add cluster --name cls0 --incnet net0 --pubnet pub0 --cfile $CFILE_PATH/CMFILE
                    cmrctl start cluster --name cls0
                    cmrctl add service --name $DB_NAME --cname cls0 --type db
                    cmrctl add db --name $TB_SID --svcname $DB_NAME --dbhome $TB_HOME
                    cmrctl add vip --name vip0 --svcname $DB_NAME --ipaddr $NODE1_VIP_IP
                fi
            elif [ $TIBERO_NODE == "cm1" ]
            then
                 cmrctl add network --name net1 --ipaddr $NODE2_INTER_IP --portno 29000
                if [ -z $NODE2_VIP_ETH ]
                then
                    cmrctl add cluster --name cls0 --incnet net1  --cfile $CFILE_PATH/CMFILE
                    cmrctl start cluster --name cls0
                    cmrctl add db --name $TB_SID --svcname $DB_NAME --dbhome $TB_HOME                          
                else
                    cmrctl add network --name pub1 --nettype public --ifname $NODE2_VIP_ETH
                    cmrctl add cluster --name cls0 --incnet net1 --pubnet pub1 --cfile $CFILE_PATH/CMFILE
                    cmrctl start cluster --name cls0
                    cmrctl add db --name $TB_SID --svcname $DB_NAME --dbhome $TB_HOME
                    cmrctl add vip --name vip1 --svcname $DB_NAME --ipaddr $NODE2_VIP_IP             
                fi
            fi
        fi
        sleep 1
    fi
    
}

FN_AUTO_CM_BOOT(){
    CM_BOOT_OPTION=$1
    echo
    echo "############################################################"
    echo "# tbis Progress> tbcm boot "    
    echo "############################################################"
    echo
    echo "tbcm boot $CM_BOOT_OPTION"
    echo 
    FN_AUTO_PROGRESS_CHECK
    echo
    if [ $YESNO == "YES" ]
    then
        if [ $TIBERO_NODE == "observer" ]
        then
            su - $USER_NAME -c "tbcmobs -b"
        else
            if [ $CM_BOOT_OPTION == "ROOT" ]
            then
                FN_AUTO_PROGRESS_PROFILE
                . $TIBERO_PROFILE_CHECK
                tbcm -b
            else
                su - $USER_NAME -c "tbcm -b"
            fi
        fi
        sleep 1 
    fi
    
}

FN_AUTO_CM_DOWN(){
    echo
    echo "############################################################"
    echo "# tbis Progress> tbcm down "    
    echo "############################################################"
    echo
    echo "tbcm down"
    echo
    FN_AUTO_PROGRESS_CHECK
    echo
    CM_DOWN_OPTION=$1
    if [ $YESNO == "YES" ]
    then
        if [ $CM_DOWN_OPTION == "ROOT" ]
        then
            FN_AUTO_PROGRESS_PROFILE
            . $TIBERO_PROFILE_CHECK
            tbcm -b
        else
            su - $USER_NAME -c "tbcm -b"
        fi
        sleep 1
    fi
 
}

FN_AUTO_CHANGE_OWNER(){
    # Owner Change Files
    echo "############################################################"
    echo "#  tbis Progress> Change Owner"
    echo "############################################################"
    echo
    echo "chwon -R $USER_NAME:$GROUP_NAME $USER_HOME"
    echo
    FN_AUTO_PROGRESS_CHECK
    if [ $YESNO == "YES" ]
    then
        chown -R $USER_NAME:$GROUP_NAME $USER_HOME
    fi
    
}

FN_AUTO_TB_BOOT(){
    TB_BOOT_OPTION=$1
    echo "############################################################"
    echo "#  tbis Progress> tbboot"
    echo "############################################################"
    echo
    echo "su - $USER_NAME -c \"tbboot" $TB_BOOT_OPTION\"""
    echo

    FN_AUTO_PROGRESS_CHECK
    if [ $YESNO == "YES" ]
    then
        TIBERO_PROCESS=`ps -ef |grep tbsvr |grep $USER_NAME |grep -v grep`
        if [ -z $TIBERO_PROCESS ]
        then
            su - $USER_NAME -c "tbboot $TB_BOOT_OPTION"
            echo
            echo
        else
            echo "tbis message> tibero Process check"
            exit
            ps -ef |grep tbsvr |grep $USER_NAME |grep -v grep
        fi
        sleep 1
    fi
    
}

FN_AUTO_TB_DOWN(){
    TB_DOWN_OPTION=$1
    echo "############################################################"
    echo "#  tbis Progress> tbdown"
    echo "############################################################"
    echo
    echo "su - $USER_NAME -c \"tbboot" $TB_DOWN_OPTION\"""
    echo
    FN_AUTO_PROGRESS_CHECK
    echo
    if [ $YESNO == "YES" ]
    then  
        su - $USER_NAME -c "tbdown $TB_DOWN_OPTION"
        sleep 1
    fi
    
}

FN_AUTO_CREATEDB(){
    echo "############################################################"
    echo "#  tbis Progress> CREATE DATABASE"
    echo "############################################################"
    echo
    echo "Execution SQL FILE : $TBIS_CWD_PATH/tbis.sql"
    echo
    FN_AUTO_PROGRESS_CHECK
    echo
    if [ $YESNO == "YES" ]
    then    
        su - $USER_NAME -c "
            tbsql -s sys/tibero <<EOF
            @$TBIS_CWD_PATH/tbis.sql
            exit
            EOF
        "

        echo
        echo
        sleep 1
    fi
}

FN_AUTO_SYSTEM_SHELL(){
    echo "############################################################"
    echo "#  tbis Progress> system.sh"
    echo "############################################################"
    echo
    echo "su - $USER_NAME -c \"sh $TB_HOME/scripts/system.sh -p1 tibero -p2 syscat -a1 Y -a2 Y -a3 Y -a4 Y\""
    echo
    FN_AUTO_PROGRESS_CHECK
    echo
    if [ $YESNO == "YES" ]
    then    
        su - $USER_NAME -c "sh $TB_HOME/scripts/system.sh -p1 tibero -p2 syscat -a1 Y -a2 Y -a3 Y -a4 Y"
        echo
        echo
        sleep 1
    fi    
}

FN_AUTO_ARCHIVE_DIR(){
    if [ $TIBERO_TYPE == "SINGLE" ]
    then
        mkdir -p $LOG_ARCHIVE_DEST/tbarch
    elif [ $TIBERO_TYPE == "TSC" ]
    then
        2>/dev/null
        if [ $TIBERO_NODE == "observer" ]
        then
            2>/dev/null
        elif [ $TIBERO_NODE == "primary" ]
        then
            mkdir -p $LOG_ARCHIVE_DEST/tbarch
        fi
    elif [ $TIBERO_TYPE == "TAC" ]
    then
        2>/dev/null
        if [ $TIBERO_NODE == "cm0" ]
        then
            mkdir -p $LOG_ARCHIVE_DEST/tbarch0
        elif [ $TIbERO_NODE == "cm1" ]
        then
            mkdir -p $LOG_ARCHIVE_DEST/tbarch0
        fi
    fi
    chown -R $USE_NAME:$GROUP_NAME $LOG_ARCHIVE_DES
}

FN_AUTO_INSTALL_CHECK(){
    clear
    . ./tbis.cfg

    TIBERO_LICENSE=`cat ../binary/license.xml |grep license |head -n 1 `
    echo "[*] TIBERO Auto installation Tools Configuration Checking STEP"
    echo "-----------------------------------------------------------------"
    echo "# OS"
    echo "- OS USER : $USER_NAME"
    echo "- OS USER GROUP : $GROUP_NAME"
    echo "- OS HOME : $USER_HOME"
    echo "-----------------------------------------------------------------"
    echo "# TIBERO Binary"
    if [ -n $TIBERO_ENGINE ]
    then
        echo "- TB_HOME PATH : $TB_HOME"
    fi  

    if [ -n $TIBERO_TBINARY ]
    then
        echo "- tbinary PATH : $TB_HOME/tbinary"
    fi
    echo "-----------------------------------------------------------------"
    echo "# TIBERO DATABASE"
    if [ $TIBERO_TYPE == "SINGLE" ]
    then
        echo "- TYPE : $TIBERO_TYPE"
        echo "- NODE : $TIBERO_NODE"
        FN_AUTO_SINGLE
    elif [ $TIBERO_TYPE == "TSC" ]
    then
        echo "- TYPE : $TIBERO_TYPE"
        echo "- NODE : $TIBERO_NODE"
        FN_AUTO_TSC
    elif [ $TIBERO_TYPE == "TAC" ]
    then
        echo "- TYPE : $TIBERO_TYPE"
        echo "- NODE : $TIBERO_NODE"
        FN_AUTO_TAC
    else
        echo "- TYPE : $TIBERO_TYPE"
        echo "- NODE : $TIBERO_NODE"
    fi

    echo "- TB_SID : $TB_SID"
    echo "- CM_SID : $TIBERO_NODE"
    echo "- CHARACTER SET : `cat tbis.sql|grep CHARACTER |awk '{print $NF}'`"
    echo "-----------------------------------------------------------------"
    echo "# TIBERO DATABASE Directory"
    echo "- CONTROL_FILE_PATH1 : $CONTROL_FILE_PATH1"
    echo "- CONTROL_FILE_PATH2 : $CONTROL_FILE_PATH2"
    echo "- DB_CREATE_FILE_DEST : $DB_CREATE_FILE_DEST"
    echo "- LOG_ARCHIVE_DEST : $LOG_ARCHIVE_DEST"
    echo "-----------------------------------------------------------------"
    echo "# TIBERO Configuration Files"
    echo "- cat tbis.cfg : TIBERO Configuration File"
    echo "- cat tbis.sql : CREATE DATABASE SQL File"
    echo "-----------------------------------------------------------------"
    
    ### IN PROCESS
    echo
    printf "continue ? ( [Y]es / [N]o / [AA] All Auto] ) : "
    read INPUT_YESNO
    case $INPUT_YESNO in
        "YES"|"Yes"|"yes"|"y"|"Y")
            INSTALL_MODE=YES;;
        "NO"|"No"|"no"|"n"|"N")
            exit;;
        "AA"|"aa")
            INSTALL_MODE=ALL;;
    esac
    echo
    ###
}

FN_AUTO_TSC_COPY(){
    echo "############################################################"
    echo "#  tbis Progress> CF/DF/ARCH COPY to Target node"
    echo "############################################################"
    echo
    echo "scp -P $SFTP_PORT -r $CONTROL_FILE_PATH1/tbctl1 "$USER_NAME"@"$NODE2_INTER_IP":$CONTROL_FILE_PATH1/tbctl1"
    echo "scp -P $SFTP_PORT -r $CONTROL_FILE_PATH2/tbctl2 "$USER_NAME"@"$NODE2_INTER_IP":$CONTROL_FILE_PATH2/tbctl2"
    echo "scp -P $SFTP_PORT -r $DB_CREATE_FILE_DEST/tbdata "$USER_NAME"@"$NODE2_INTER_IP":$DB_CREATE_FILE_DEST/tbdata"
    echo "scp -P $SFTP_PORT -r $LOG_ARCHIVE_DEST/tbarch "$USER_NAME"@"$NODE2_INTER_IP":$LOG_ARCHIVE_DEST/tbarch"
    echo
    FN_AUTO_PROGRESS_CHECK
    echo
    if [ $YESNO == "YES" ]
    then  
        scp -P $SFTP_PORT -r $CONTROL_FILE_PATH1/tbctl1 "$USER_NAME"@"$NODE2_INTER_IP":$CONTROL_FILE_PATH1/tbctl1
        scp -P $SFTP_PORT -r $CONTROL_FILE_PATH2/tbctl2 "$USER_NAME"@"$NODE2_INTER_IP":$CONTROL_FILE_PATH2/tbctl2
        scp -P $SFTP_PORT -r $DB_CREATE_FILE_DEST/tbdata "$USER_NAME"@"$NODE2_INTER_IP":$DB_CREATE_FILE_DEST/tbdata
        scp -P $SFTP_PORT -r $LOG_ARCHIVE_DEST/tbarch "$USER_NAME"@"$NODE2_INTER_IP":$LOG_ARCHIVE_DEST/tbarch
    fi    
}

FN_AUTO_TSC_CFG(){
    echo "############################################################"
    echo "#  tbis Progress> Target TSC Configuration"
    echo "############################################################"
    echo
    echo "ALTER DATABASE STANDBY CONTROLFILE;"
    echo
    FN_AUTO_PROGRESS_CHECK
    echo
    if [ $YESNO == "YES" ]
    then   
        su - $USER_NAME -c "
            tbsql -s sys/tibero <<EOF
            ALTER DATABASE STANDBY CONTROLFILE;
            exit
            EOF
        "
        sleep 1
    fi
}

FN_AUTO_SUCCESS(){
    echo "############################################################"
    echo "#  tbis Progress> last step done"
    echo "# TIBERO_TYPE : $TIBERO_TYPE"
    echo "# TIBERO_NODE : $TIBERO_NODE"
    echo "############################################################"
    echo
    echo
    
}

FN_AUTO_TAC_CFG(){
    echo "############################################################"
    echo "#  tbis Progress> TAC Configuration"
    echo "############################################################"
    echo
    echo "CREATE UNDO1 TABLESPACE"
    echo "THREAD 1 REDO CREATE"
    echo "THREAD 1 ENABLE"
    echo
    FN_AUTO_PROGRESS_CHECK
    echo
    if [ $YESNO == "YES" ]
    then  
        su - $USER_NAME -c "
            tbsql -s sys/tibero <<EOF
            CREATE UNDO TABLESPACE UNDO01 DATAFILE 'system/undo1001.dtf' SIZE 1G AUTOEXTEND OFF;
            ALTER DATABASE ADD LOGFILE THREAD 1 GROUP 5 ('$DB_CREATE_FILE_DEST/tbdata/system/redo051.redo','$DB_CREATE_FILE_DEST/tbdata/system/redo052.redo') SIZE 300M;
            ALTER DATABASE ADD LOGFILE THREAD 1 GROUP 6 ('$DB_CREATE_FILE_DEST/tbdata/system/redo061.redo','$DB_CREATE_FILE_DEST/tbdata/system/redo062.redo') SIZE 300M;
            ALTER DATABASE ADD LOGFILE THREAD 1 GROUP 7 ('$DB_CREATE_FILE_DEST/tbdata/system/redo071.redo','$DB_CREATE_FILE_DEST/tbdata/system/redo072.redo') SIZE 300M;
            ALTER DATABASE ADD LOGFILE THREAD 1 GROUP 8 ('$DB_CREATE_FILE_DEST/tbdata/system/redo081.redo','$DB_CREATE_FILE_DEST/tbdata/system/redo082.redo') SIZE 300M;
            ALTER DATABASE ADD LOGFILE THREAD 1 GROUP 9 ('$DB_CREATE_FILE_DEST/tbdata/system/redo091.redo','$DB_CREATE_FILE_DEST/tbdata/system/redo092.redo') SIZE 300M;
            ALTER DATABASE ENABLE PUBLIC THREAD 1;
            exit
            EOF
        "
    fi
    sleep 1
}

FN_AUTO_INSTALL(){   
    chmod 655 tbis.log
    TBIS_AUTO_TIME=`date +%F_%T |sed 's/://g' |sed 's/-//g'`
    TBIS_START_TIME=$TBIS_AUTO_TIME
    echo "############################################################"
    echo "# tbis Start Log"
    echo "############################################################"
    echo "# Start time : $TBIS_START_TIME"

    ############# In Progress
    FN_AUTO_INSTALL_CHECK
    FN_AUTO_CNF_CHECK 
    FN_AUTO_ENGINE
    FN_AUTO_TBINARY
    FN_AUTO_PROFILE
    FN_AUTO_TB_SID_TIP
    FN_AUTO_TBDSN
    
    if [ $TIBERO_TYPE == "SINGLE" ]
    then
        FN_AUTO_LICENSE
        FN_AUTO_CHANGE_OWNER
        FN_AUTO_TB_BOOT NOMOUNT
        FN_AUTO_CREATEDB
        FN_AUTO_TB_BOOT NORMAL
        FN_AUTO_SYSTEM_SHELL
    elif [ $TIBERO_TYPE == "TSC" ]
    then
        if [ $TIBERO_NODE == "primary" ]
        then
            FN_AUTO_LICENSE
            FN_AUTO_CM_SID_TIP
            FN_AUTO_CHANGE_OWNER
            FN_AUTO_CM_BOOT ROOT
            FN_AUTO_CM_RESOURCE
            if [ -z $NODE1_VIP_ETH]
            then
                FN_AUTO_CM_DOWN
                FN_AUTO_CM_BOOT
            else
                2>/dev/null
            fi
            FN_AUTO_CHANGE_OWNER
            FN_AUTO_TB_BOOT NOMOUNT
            FN_AUTO_CREATEDB
            FN_AUTO_TB_BOOT NORMAL
            FN_AUTO_SYSTEM_SHELL
            FN_AUTO_TB_DOWN IMMEDIATE
            FN_AUTO_TSC_COPY
        elif [ $TIBERO_NODE == "standby" ]
        then
            FN_AUTO_LICENSE
            FN_AUTO_CM_SID_TIP
            FN_AUTO_CHANGE_OWNER
            FN_AUTO_CM_BOOT ROOT
            FN_AUTO_CM_RESOURCE
            if [ -z $NODE2_VIP_ETH]
            then
                FN_AUTO_CM_DOWN
                FN_AUTO_CM_BOOT
            else
                2>/dev/null
            fi            
            FN_AUTO_CHANGE_OWNER
            FN_AUTO_TB_BOOT MOUNT
            FN_AUTO_TSC_CFG
            FN_AUTO_TB_DOWN IMMEDIATE
        elif [ $TIBERO_NODE == "observer" ]
        then
            FN_AUTO_CM_SID_TIP
            FN_AUTO_CHANGE_OWNER
            FN_AUTO_CM_BOOT
        fi
    elif [ $TIBERO_TYPE == "TAC" ]
    then
        if [ $TIBERO_NODE == "cm0" ]
        then
            FN_AUTO_LICENSE
            FN_AUTO_CM_SID_TIP
            FN_AUTO_CHANGE_OWNER
            FN_AUTO_CM_BOOT ROOT
            FN_AUTO_CM_RESOURCE
            if [ -z $NODE1_VIP_ETH]
            then
                FN_AUTO_CM_DOWN
                FN_AUTO_CM_BOOT
            else
                2>/dev/null
            fi
            FN_AUTO_CHANGE_OWNER
            FN_AUTO_TB_BOOT NOMOUNT
            FN_AUTO_CREATEDB
            FN_AUTO_TB_BOOT NORMAL
            FN_AUTO_SYSTEM_SHELL
            FN_AUTO_TAC_CFG
        elif [ $TIBERO_NODE == "cm1" ]
        then
            FN_AUTO_LICENSE
            FN_AUTO_CM_SID_TIP
            FN_AUTO_CHANGE_OWNER
            FN_AUTO_CM_BOOT ROOT
            FN_AUTO_CM_RESOURCE
            if [ -z $NODE2_VIP_ETH]
            then
                FN_AUTO_CM_DOWN
                FN_AUTO_CM_BOOT
            else
                2>/dev/null
            fi
            FN_AUTO_CHANGE_OWNER
            FN_AUTO_TB_BOOT NORMAL
        fi
    fi
    FN_AUTO_ARCHIVE_DIR
    FN_AUTO_SUCCESS
    
    TBIS_AUTO_TIME=`date +%F_%T |sed 's/://g' |sed 's/-//g'`
    TBIS_END_TIME=$TBIS_AUTO_TIME
    echo "############################################################"
    echo "# tbis END Log"
    echo "############################################################"
    echo "# End time : $TBIS_END_TIME"
    ############
}

FN_AUTO_CNF_CHECK(){
    # tbis.cfg Parameter Check
    if [ -z $TIBERO_TYPE]
    then
        echo "tbis message> tbis.cfg - TIBERO_TYPE check"
        exit
    elif [ -z $TIBERO_NODE ]
    then
        echo "tbis message> tbis.cfg - TIBERO_NODE check"
        exit
    elif [ $TIBERO_TYPE == "SINGLE" ]
    then
        if [ $TIBERO_NODE != "SINGLE" ]
        then
            echo "tbis message> tbis.cfg - TIBERO_NODE check ($TIBERO_NODE)"
            exit
        fi
    elif [ $TIBERO_TYPE == "TSC" ]
    then
        if [ $TIBERO_NODE == "SINGLE" ] || [ $TIBERO_NODE == "cm0" ] || [ $TIBERO_NODE == "cm1" ]
        then
            echo "tbis message> tbis.cfg - TIBERO_NODE check ($TIBERO_NODE)"
            exit     
        fi

        if [ -z $NODE1_INTER_IP ]
        then
            echo "tbis message> tbis.cfg - NODE1_INTER_IP check"
            exit
        fi

        if [ -z $NODE2_INTER_IP ]
        then
            echo "tbis message> tbis.cfg - NODE2_INTER_IP check"
            exit    
        fi
    elif [ $TIBERO_TYPE == "TAC" ]
    then
        if [ $TIBERO_NODE == "SINGLE" ] || [ $TIBERO_NODE == "observer" ] || [ $TIBERO_NODE == "primary" ] || [ $TIBERO_NODE == "standby" ]
        then
            echo "tbis message> tbis.cfg - TIBERO_NODE check ($TIBERO_NODE)"
            exit
        fi

        if [ -z $NODE1_INTER_IP ]
        then
            echo "tbis message> tbis.cfg - NODE1_INTER_IP check"
            exit
        fi

        if [ -z $NODE2_INTER_IP ]
        then
            echo "tbis message> tbis.cfg - NODE2_INTER_IP check"
            exit    
        fi

        if [ -z $CFILE_PATH ]
        then
            echo "tbis message> tbis.cfg - CFILE_PATH check"
            exit    
        fi
    fi

    if [ -z $USER_NAME ]
    then
        echo "tbis message> tbis.cfg - USER_NAME check"
        exit
    fi

    if [ -z $USER_HOME ]
    then
        echo "tbis message> tbis.cfg - USER_HOME check"
        exit
    fi

    if [ -z $GROUP_NAME ]
    then
        echo "tbis message> tbis.cfg - GROUP_NAME check"
        exit
    fi

    if [ -z $DB_NAME ]
    then
        echo "tbis message> tbis.cfg - DB_NAME check"
        exit
    fi

    if [ -z $TB_HOME ]
    then
        echo "tbis message> tbis.cfg - TB_HOME check"
        exit
    fi

    if [ -z $CONTROL_FILE_PATH1 ]
    then
        echo "tbis message> tbis.cfg - CONTROL_FILE_PATH1 check"
        exit
    fi

    if [ -z $CONTROL_FILE_PATH2 ]
    then
        echo "tbis message> tbis.cfg - CONTROL_FILE_PATH2 check"
        exit
    fi

    if [ -z $DB_CREATE_FILE_DEST ]
    then
        echo "tbis message> tbis.cfg - DB_CREATE_FILE_DEST check"
        exit
    fi

    if [ -z $LOG_ARCHIVE_DEST ]
    then
        echo "tbis message> tbis.cfg - LOG_ARCHIVE_DEST check"
        exit
    fi
}
FN_CONF_MENU(){
    echo " -----------------------------------------------------------------------------------"
    echo "  1.TIBERO USER CREATE                      |  2.TIBERO User Profile                  "
    echo " ---------------------------------------- + ----------------------------------------"
    echo "  # 11 - MANUAL                             |  # 21 - MANUAL                            "
    echo "                                            |                                         "
    echo " -----------------------------------------------------------------------------------"
    echo "  3.TIBERO Directory                        |  4.TIBERO TIP                           "
    echo " ---------------------------------------- + ----------------------------------------"
    echo "  # 31 - MANUAL                             |  # 41 - MANUAL                            "
    echo "                                            |                                         "
    echo " -----------------------------------------------------------------------------------"
    echo "  5.TIBERO CREATE DATABASE                  |  6.TIBERO CM Resource                   "
    echo " ---------------------------------------- + ----------------------------------------"
    echo "  # 51 - MANUAL                             |  # 61 - MANUAL                            "
    echo "                                            |                                         "
    echo " -----------------------------------------------------------------------------------"
    echo "  c  - Clear terminal                                                               "
    echo "  r  - retry main menu                                                              "
    echo "  press other key to quit                                                                  "
    echo " -----------------------------------------------------------------------------------"
    printf " Choose the Number or Command : "
    read INPUT_NUMBER
}

FN_MAIN_MENU(){
    clear
    echo "[*] TIBERO Installation Shell Script"
    echo "[*] This script is for TmaxTibero "Daejeon Office" only."
    echo "[*] Supported Version : Tibero 6 FS07 ↑"
    echo "-----------------------------------------------------------------"
    echo "# 1. Auto installation"
    echo "-----------------------------------------------------------------"
    echo "# chk. System Check"
    echo "# ini. Configurations Initialization"
    echo "# press other key to quit"
    echo "-----------------------------------------------------------------"
    printf "Choose the Number : "
    read INPUT_NUMBER
    case $INPUT_NUMBER in
    1)
        clear
        FN_AUTO_LOGFILE
        FN_AUTO_INSTALL |tee $TBIS_AUTO_LOGFILE 
        exit;;
    *)
        clear
        echo "tbis message> program quit."
        ;;
    esac
}

############################################################
#
# Program start
############################################################
# run
FN_MAIN_MENU 2>/dev/null
#FN_MAIN_MENU